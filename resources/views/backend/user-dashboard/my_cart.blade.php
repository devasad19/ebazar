@extends('apps.dashboard_master')

@section('content')

<div class="flex min-h-screen bg-gray-50">

    <!-- ЁЯЯв Sidebar -->
    @include('backend.patrials.aside')
    <!-- ЁЯЯб Main Content Area -->
    <div class="flex-1 flex flex-col">

        <!-- Top Bar -->
    @include('backend.patrials.top_bar')
        <form action="{{ route('place.order') }}" method="POST" class="space-y-6">
    @csrf
        <!-- Content Body --> 
  <section class="bg-gray-50 p-6 rounded-2xl shadow">
     <h2 class="text-2xl font-bold text-green-700 mb-6">ЁЯЫТ ржЖржорж╛рж░ ржХрж╛рж░рзНржЯ</h2>
        
    @if(count($cartItems) > 0)
        <div class="space-y-3">
            @foreach($cartItems as $cart)
<div class="cart-item flex justify-between items-center border-b pb-3 py-2 gap-4" data-product_id="{{ $cart->product_id }}" data-id="{{ $cart->id }}">
    <!-- Product Info -->
    <div class="flex items-center gap-3 w-1/3">
        <img src="{{ $cart->product->image ? url('uploads/products/'.$cart->product->image) : '' }}"
             class="w-16 h-16 object-cover rounded-lg">
        <h4 class="font-semibold text-gray-800">{{ $cart->product->name }}</h4>
    </div>

    <!-- Quantity Control -->
    <div class="flex items-center justify-center w-1/4">
        <button type="button" 
            class="bg-indigo-500 text-white px-3 py-1 rounded-l-full"
            onclick="changeQty(this, 'decrease')">-</button>
        <input type="number" 
            value="{{ $cart->quantity }}" 
            min="1"
            class="w-16 text-center border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-300 py-1 mx-1 rounded">
        <button type="button" 
            class="bg-indigo-500 text-white px-3 py-1 rounded-r-full"
            onclick="changeQty(this, 'increase')">+</button>
    </div>

    <!-- Price Info -->
    <div class="flex flex-col items-center w-1/4">
        <p class="text-green-600 text-sm">рз│{{ $cart->price }} x <span class="itemQty">{{ $cart->quantity }}</span></p>
        <p></p>
    </div>
    
    <!-- Remove Button -->
    <div class="flex3 items-center text-right justify-end w-1/6">
        <p class="text-green-700 font-semibold text-base itemTotal">рз│{{ $cart->price * $cart->quantity }}</p>
        <button type="button" class="text-red-500 hover:text-red-700 text-lg font-bold"
            onclick="removeItem(this)">тЭМ</button>
    </div>
</div>
            @endforeach
        </div>

        <!-- тЬЕ Custom Products Section (now inside form) -->
        <div class="bg-gray-50 rounded-2xl border p-5  mt-3" id="customProductsSection">
            <h3 class="text-lg font-semibold text-gray-700 mb-4 flex justify-between">
                <span>тЮХ ржХрж╛рж╕рзНржЯржо ржкржгрзНржп ржпрзЛржЧ ржХрж░рзБржи</span>
                <button type="button" id="addCustomProduct"
                    class="bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700 transition">+ ржирждрзБржи ржкржгрзНржп</button>
            </h3>
            <div id="customProductList" class="space-y-3 w-full"></div>
                
        </div>

        <input type="hidden" id="baseTotal" value="{{ $total }}">
<input type="hidden" id="customTotal" name="customTotal" value="0">


        <div class="flex justify-between mt-6 text-lg font-bold text-green-700">
            <span>ржорзЛржЯ</span>
            <span id="cartTotal">рз│{{ $total }} <span class="text-sm text-gray-600 mb-1">+ ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ ржЪрж╛рж░рзНржЬ</span></span>
        </div>
        <p class="text-sm text-red-500 mt-3 text-right">ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ ржЪрж╛рж░рзНржЬржГ ржЖржкржирж╛рж░ ржмрж╛рзЬрж┐ ржерзЗржХрзЗ ржмрж╛ржЬрж╛рж░рзЗрж░ ржжрзВрж░рждрзНржм, ржнрзЗржи ржмрж╛ ржЕржЯрзЛрж░рж┐ржХрж╢рж╛рж░ ржнрж╛рзЬрж╛рж░ рж╕ржорж╛ржиред</p>


    <div class="bg-white rounded-2xl shadow p-6">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ рждржерзНржп</h3>

            @php
                // Example: user profile data
                $userName = Auth::user()->name ?? 'ржорзЛржГ ржЖрж╣рж╛ржж ржЖрж▓рзА';
                $fatherName = Auth::user()->father_name ?? 'ржорзЛржГ ржЬржорж╢рзЗржж ржЖрж▓рзА';
                $userAddress = Auth::user()->address ?? 'рж░рж╛ржорж╛ржХрж╛ржирж╛, ржжрзБрж▓рзНрж▓рж╛, ржЪрзЗржЪрзБрзЯрж╛рзЯ ржмрж╛ржЬрж╛рж░';
                $userPhone = Auth::user()->phone ?? 'рзжрззрзирзкрзнрзорзорзлрзлрзлрзлрзл';
            @endphp

            <!-- Name -->
            <div class="flex flex-col">
                <label for="name" class="text-sm text-gray-600 mb-1">ржЖржкржирж╛рж░ ржирж╛ржо</label>
                <input type="text" name="name" id="name" value="{{ $userName }}" 
                    class="w-full border px-3 py-2 rounded-lg focus:ring-2 focus:ring-green-400 outline-none" readonly>
            </div>

            <!-- Father's Name -->
            <div class="flex flex-col">
                <label for="father_name" class="text-sm text-gray-600 mb-1">ржкрж┐рждрж╛рж░ ржирж╛ржо</label>
                <input type="text" name="father_name" id="father_name" value="{{ $fatherName }}" 
                    class="w-full border px-3 py-2 rounded-lg focus:ring-2 focus:ring-green-400 outline-none" readonly>
            </div>

            <!-- New Address Checkbox -->
            <div class="flex items-center gap-2">
                <input type="checkbox" id="newAddress" class="form-checkbox h-5 w-5 text-green-600">
                <label for="newAddress" class="text-sm text-gray-700">ржирждрзБржи ржарж┐ржХрж╛ржирж╛ ржпрзЛржЧ ржХрж░рзБржи</label>
            </div>

            <!-- Address -->
            <div class="flex flex-col">
                <label for="addressInput" class="text-sm text-gray-600 mb-1">ржарж┐ржХрж╛ржирж╛</label>
                <input type="text" name="address" id="addressInput" 
                    value="{{ $userAddress }}" 
                    class="w-full border px-3 py-2 rounded-lg focus:ring-2 focus:ring-green-400 outline-none" 
                    placeholder="ржарж┐ржХрж╛ржирж╛" readonly>
            </div>

            <!-- Phone -->
            <div class="flex flex-col">
                <label for="phoneInput" class="text-sm text-gray-600 mb-1">ржорзЛржмрж╛ржЗрж▓ ржиржорзНржмрж░</label>
                <input type="tel" name="phone" id="phoneInput" 
                    value="{{ $userPhone }}" 
                    class="w-full border px-3 py-2 rounded-lg focus:ring-2 focus:ring-green-400 outline-none" 
                    placeholder="ржорзЛржмрж╛ржЗрж▓ ржиржорзНржмрж░" readonly>
            </div>

            <button type="submit" class="bg-green-600 text-white w-full py-3 rounded-lg hover:bg-green-700 transition font-semibold">
                тЬЕ ржЕрж░рзНржбрж╛рж░ ржХржиржлрж╛рж░рзНржо ржХрж░рзБржи
            </button>
        </div>

        @else
        <p class="text-center text-gray-500 py-12">ржЖржкржирж╛рж░ ржХрж╛рж░рзНржЯ ржЦрж╛рж▓рж┐ред ЁЯЫТ</p>
        @endif

    </form>
</section>

 

<!-- Quantity Updated Notification -->
<div id="qtyNotification" 
     class="fixed bottom-5 right-5 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50">
  тЬЕ Quantity updated
</div>
 
    </div>
</div>

@endsection
@section('scripts')
<script>


function showQtyNotification() {
    const notif = document.getElementById('qtyNotification');
    if (!notif) return;

    notif.classList.remove('opacity-0');
    notif.classList.add('opacity-100');

    // рзи рж╕рзЗржХрзЗржирзНржб ржкрж░рзЗ ржЖржмрж╛рж░ fade out рж╣ржмрзЗ
    setTimeout(() => {
        notif.classList.remove('opacity-100');
        notif.classList.add('opacity-0');
    }, 2000);
}

 // ======================
// ЁЯЫТ Main Cart Functions
// ======================

// ЁЯФ╣ Quantity Change
function changeQty(btn, type) {
    const item = btn.closest('.cart-item');
    if (!item) return;

    const input = item.querySelector('input');
    let qty = parseInt(input.value);
    qty = type === 'increase' ? qty + 1 : Math.max(1, qty - 1);
    input.value = qty;

    const itemQty = item.querySelector('.itemQty');
    if (itemQty) itemQty.textContent = qty;

    const id = item.dataset.id;

    $.ajax({
        url: "{{ route('cart.update') }}",
        method: 'POST',
        data: { id, quantity: qty },
        success: function (data) {
            if (data.success) {
                item.querySelector('.itemTotal').innerText = `рз│${data.itemTotal}`;
                document.getElementById('baseTotal').value = data.cartTotal; // update hidden baseTotal
                updateGrandTotal();
                showToast('success', 'Updated', 'ржкрж░рж┐ржорж╛ржг ржЖржкржбрзЗржЯ рж╣рзЯрзЗржЫрзЗ тЬЕ');
            } else {
                showToast('error', 'Failed', 'ржЖржкржбрзЗржЯ ржмрзНржпрж░рзНрже рж╣рзЯрзЗржЫрзЗ тЭМ');
            }
        },
        error: function () {
            showToast('error', 'Server Error', 'рж╕рж╛рж░рзНржнрж╛рж░рзЗ рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗ!');
        },
    });
}

// ЁЯФ╣ Remove Item
function removeItem(btn) {
    const item = btn.closest('.cart-item');
    if (!item) return;

    console.log(item);
    
    const id = item.dataset.product_id;
    const routeUrl = `{{ route('cart.remove', ':id') }}`.replace(':id', id);

    swalConfirm('ржЖржкржирж┐ ржХрж┐ ржПржЗ ржкржгрзНржпржЯрж┐ ржХрж╛рж░рзНржЯ ржерзЗржХрзЗ ржорзБржЫрзЗ ржлрзЗрж▓рждрзЗ ржЪрж╛ржи?', function () {
        $.ajax({
            url: routeUrl,
            method: 'POST',
            success: function (data) {
                if (data.success) {
                    item.remove();
                    document.getElementById('baseTotal').value = data.cartTotal;
                    updateGrandTotal();
                    showToast('success', 'Removed', 'ржкржгрзНржпржЯрж┐ ржорзБржЫрзЗ ржлрзЗрж▓рж╛ рж╣рзЯрзЗржЫрзЗ ЁЯЧСя╕П');
                } else {
                    showToast('error', 'Failed', 'рж░рж┐ржорзБржн ржХрж░рж╛ ржпрж╛рзЯржирж┐!');
                }
            },
            error: function () {
                showToast('error', 'Server Error', 'рж╕рж╛рж░рзНржнрж╛рж░рзЗ рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗ!');
            },
        });
    });
}

// ЁЯФ╣ New Address Toggle
const newAddressCheckbox = document.getElementById('newAddress');
const addressInput = document.getElementById('addressInput');
const phoneInput = document.getElementById('phoneInput');

if (newAddressCheckbox) {
    newAddressCheckbox.addEventListener('change', function () {
        const editable = this.checked;
        [addressInput, phoneInput].forEach((input) => {
            if (editable) {
                input.removeAttribute('readonly');
                input.focus();
            } else {
                input.setAttribute('readonly', true);
            }
        });
    });
}

// ===========================
// ЁЯзй Custom Product Functions
// ===========================

document.getElementById('addCustomProduct').addEventListener('click', function () {
    const id = Date.now();

    const productHtml = `
        <div class="custom-product border p-4 rounded-2xl bg-gray-50 shadow-sm flex flex-col md:flex-row md:items-center md:gap-3 gap-3" data-id="${id}">
            <input type="text" name="custom_products[${id}][name]" class="cp-name border border-green-300 p-2 rounded-lg w-full focus:ring-2 focus:ring-green-400 outline-none" placeholder="ржкржгрзНржпрзЗрж░ ржирж╛ржо" required>

            <div class="flex flex-col sm:flex-row w-full gap-3">
                <input type="number" name="custom_products[${id}][qty]" class="cp-qty border border-green-300 p-2 rounded-lg w-full sm:w-1/3 focus:ring-2 focus:ring-green-400 outline-none"
                    placeholder="ржкрж░рж┐ржорж╛ржг" step="0.1">

                <select name="custom_products[${id}][unit]" class="cp-unit border border-green-300 p-2 rounded-lg w-full sm:w-1/3 focus:ring-2 focus:ring-green-400 outline-none" required>
                    <option value="ржХрзЗржЬрж┐">ржХрзЗржЬрж┐</option>
                    <option value="рж▓рж┐ржЯрж╛рж░">рж▓рж┐ржЯрж╛рж░</option>
                    <option value="ржкрж┐рж╕">ржкрж┐рж╕</option>
                    <option value="ржбржЬржи">ржбржЬржи</option>
                    <option value="ржЯрж╛ржХрж╛">ржЯрж╛ржХрж╛</option>
                </select>

                <input type="number" name="custom_products[${id}][price]" class="cp-price border border-green-300 p-2 rounded-lg w-full sm:w-1/3 focus:ring-2 focus:ring-green-400 outline-none"
                    placeholder="ржорзВрж▓рзНржп (рз│)">
            </div>

            <button type="button" class="text-red-500 hover:text-red-700 font-bold text-2xl self-end md:self-center removeCustom">├Ч</button>
        </div>
    `;

    document.getElementById('customProductList').insertAdjacentHTML('beforeend', productHtml);
    updateCustomTotal();
});

document.addEventListener('click', function (e) {
    if (e.target.classList.contains('removeCustom')) {
        e.target.closest('.custom-product').remove();
        updateCustomTotal();
    }
});

document.addEventListener('input', function (e) {
    if (e.target.closest('.custom-product')) {
        updateCustomTotal();
    }
});

// ЁЯФ╣ Custom total рж╣рж┐рж╕рж╛ржм ржХрж░рж╛
function updateCustomTotal() {
    let customTotal = 0;

    document.querySelectorAll('.custom-product').forEach((el) => {
        const qty = parseFloat(el.querySelector('.cp-qty')?.value || 0);
        const unit = el.querySelector('.cp-unit')?.value;
        const price = parseFloat(el.querySelector('.cp-price')?.value || 0);

        if (unit === 'ржЯрж╛ржХрж╛') {
            customTotal += price;
        } else if (qty > 0 && price > 0) {
            customTotal += qty * price;
        }
    });

    // Hidden custom total update
    document.getElementById('customTotal').value = customTotal;
    updateGrandTotal();
}

// ЁЯФ╣ Base + Custom ржпрзЛржЧ ржХрж░рзЗ Grand total ржжрзЗржЦрж╛ржирзЛ
function updateGrandTotal() {
    const base = parseFloat(document.getElementById('baseTotal').value || 0);
    const custom = parseFloat(document.getElementById('customTotal').value || 0);
    const grand = base + custom;

    document.getElementById('cartTotal').innerText = `рз│${grand.toFixed(2)}`;
}


</script>
@endsection